# x402scan Registration Guide

## Registration Form Fields

When registering your API resources on x402scan, you'll see these fields:

### 1. Resource URL ‚úÖ
```
https://sundial.exchange/api/stats
```

### 2. Optional Headers

x402scan allows you to add custom headers that will be sent with every request. This is important for:
- CORS handling
- API authentication
- Custom metadata

## Recommended Headers for x402scan

### Option 1: No Custom Headers (Try This First)

**Don't add any custom headers initially.** Let x402scan send requests normally. Our middleware should handle:
- CORS automatically (Next.js handles this)
- Origin detection
- Payment verification

### Option 2: Add Origin Header (If CORS Issues)

If x402scan is being blocked by CORS or origin checks:

**Header Name:** `Origin`  
**Header Value:** `https://www.x402scan.com`

This will help our middleware recognize x402scan requests (though they shouldn't be exempt from payment).

### Option 3: Add Custom Identifier

To help track x402scan requests in logs:

**Header Name:** `X-Client`  
**Header Value:** `x402scan`

Or:

**Header Name:** `User-Agent`  
**Header Value:** `x402scan-client`

## Why You're Getting 402 After Payment

The issue is **NOT** the initial 402 response (that's correct). The issue is that after you pay:

1. ‚úÖ x402scan completes the transaction on Base
2. ‚úÖ x402scan generates the signed payment proof
3. ‚ùå **x402scan sends request WITH `X-PAYMENT` header**
4. ‚ùå **Our middleware doesn't recognize the payment as valid**
5. ‚ùå **Returns another 402 response**

## Possible Causes

### 1. **Origin/Referer Exemption Issue**

Our middleware exempts `sundial.exchange` origins:

```typescript
const EXEMPT_ORIGINS = [
    "http://localhost:3000",
    "https://sundial.exchange",
    "https://www.sundial.exchange",
]
```

**Problem:** If x402scan sends `Origin: https://www.x402scan.com`, it's correctly NOT exempted and goes through payment flow. ‚úÖ This is correct!

### 2. **Resource URL Mismatch**

x402scan might be:
- Requesting: `https://sundial.exchange/api/stats`
- But payment was for: `https://www.sundial.exchange/api/stats`

Or vice versa due to DNS resolution.

### 3. **Payment Verification Failing**

The facilitator (PayAI) might be rejecting the verification due to:
- Resource URL mismatch
- Amount mismatch
- Timeout expired
- Invalid signature

## Testing Strategy

### Step 1: Check What x402scan Actually Sends

The debug logs we added will show:

```
[x402] No payment header found, returning 402
```
OR
```
[x402] Payment header received: eyJ...
[x402] Verifying payment for resource: https://...
[x402] base verification response (200): {"isValid":false,"invalidReason":"..."}
```

### Step 2: Add Specific x402scan Logging

Let me add a check to see if x402scan is making the request:

```typescript
// In middleware
const userAgent = request.headers.get("user-agent") || ""
const origin = request.headers.get("origin") || ""
const referer = request.headers.get("referer") || ""

console.log("[x402] Request from:", {
    origin,
    referer,
    userAgent: userAgent.substring(0, 50),
    hasPayment: !!request.headers.get("x-payment")
})
```

### Step 3: Verify DNS Setup

```bash
# Check both domains resolve correctly
dig sundial.exchange A
dig www.sundial.exchange A

# They should have the same IP or both point to Vercel
```

## Recommended x402scan Configuration

### For Each Endpoint:

**Resource URL:**
```
https://sundial.exchange/api/stats
```

**Headers:** (Leave empty initially)

```
No headers needed
```

**Or if CORS issues** (try after checking logs):

```
Header Name:  Origin
Header Value: https://www.x402scan.com
```

## What NOT To Add

‚ùå **Don't add:** `X-PAYMENT` header
- This is auto-generated by x402scan after payment
- You can't pre-set this

‚ùå **Don't add:** Authorization headers
- Your API doesn't use these

‚ùå **Don't add:** Content-Type
- x402scan handles this automatically

## Debugging Checklist

After registration, when you try to use the API through x402scan:

1. ‚úÖ Initial 402 response appears
2. ‚úÖ x402scan shows payment UI ($0.10 USDC on Base)
3. ‚úÖ You approve transaction
4. ‚úÖ Transaction succeeds (check wallet)
5. ‚ùì **x402scan should now retry the request WITH `X-PAYMENT` header**
6. ‚ùì **Our middleware should verify payment**
7. ‚ùì **API should return data**

**Where it's failing:** Steps 5-7

## Action Plan

### Immediate Actions:

1. **Deploy Current Code** (with debug logging)
   ```bash
   git add middleware.ts
   git commit -m "Add x402 debug logging"
   git push
   ```

2. **Test on x402scan Again**
   - Click "Request" on your registered resource
   - Complete the payment
   - **Take a screenshot of the error**

3. **Check Vercel Logs**
   - Go to Vercel dashboard
   - Check "Functions" logs
   - Look for `[x402]` messages
   - **Copy all the log output**

4. **Share the Logs Here**
   - The logs will tell us exactly what's happening
   - We can then fix the specific issue

### If Logs Show "No payment header found":

x402scan isn't sending the `X-PAYMENT` header. This could be:
- x402scan bug
- CORS blocking the header
- Need to add custom header configuration

**Fix:** Try adding to x402scan registration:
```
Header Name:  X-Client
Header Value: x402scan-ui
```

### If Logs Show "Payment verification failed":

The header is being sent but verification is failing. Common causes:
- Resource URL mismatch
- Amount mismatch  
- Network mismatch

**Fix:** We'll adjust the middleware based on the `invalidReason` in logs

## Expected Vercel Log Output (When Working)

```
[x402] Request from: {
  origin: 'https://www.x402scan.com',
  referer: 'https://www.x402scan.com/resources/123',
  userAgent: 'Mozilla/5.0...',
  hasPayment: true
}
[x402] Payment header received: eyJhbGciOiJFUzI1NiIsInR5cCI6IkpXVCJ...
[x402] Verifying payment for resource: https://sundial.exchange/api/stats
[x402] Trying verification with base network...
[x402] base verification response (200): {"isValid":true}
[x402] Payment verified successfully on base!
[x402] Verification result: { isValid: true, network: 'base', invalidReason: null }
[x402] Settlement result: { success: true, txHash: '0xabc123...', error: null }
```

Then the API returns data! üéâ

## Next Steps

**Don't add any custom headers to x402scan yet.** 

First:
1. Deploy the logging changes
2. Try x402scan again
3. Share the Vercel logs

The logs will tell us exactly what's wrong and we can fix it! üîç

---

**TL;DR for x402scan registration:**
- ‚úÖ Resource URL: `https://sundial.exchange/api/stats`
- ‚úÖ Headers: Leave empty (for now)
- ‚úÖ Deploy, test, check logs
- ‚úÖ We'll adjust based on what logs show

